---
---
stages:
  - dependencies
  - save
  - processing
  - analyze
  - deploy

variables:
  NODE_ENV: "production"

image: node:latest

cache:
  key: .db-sqlite
  paths:
    - .db-sqlite/*

install-dependencies:on-schedule:
  stage: dependencies
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm install
  cache:
    paths:
      - node_modules/
  artifacts:
    untracked: true
    paths:
      - node_modules/

github-data:on-schedule:
  stage: dependencies
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run database-git
  cache:
    paths:
      - .db-github-data/
  artifacts:
    paths:
      - .db-github-data/

database-stripe:on-schedule:
  stage: dependencies
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run database-stripe
  needs: ["install-dependencies:on-schedule"]
  cache:
    paths:
      - .db-sqlite/
  artifacts:
    paths:
      - .db-sqlite/

save-companies:on-schedule:
  stage: save
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run save-companies
  needs: ["github-data:on-schedule"]

.save-jobs:on-schedule:
  stage: save
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run save-jobs
  needs: ["github-data:on-schedule"]

processing-companies:on-schedule:
  stage: processing
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run processing-companies
  needs: ["save-companies:on-schedule"]

.processing-jobs:on-schedule:
  stage: processing
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run processing-jobs
  needs: ["save-jobs:on-schedule"]

processing-stripe-companies:on-schedule:
  stage: processing
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run processing-stripe
  needs: ["processing-companies:on-schedule"]

.heatmap:on-schedule:
  stage: analyze
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run heatmap-agg

analyze:on-schedule:
  stage: analyze
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  script:
    - npm run analyze-companies
    - npm run analyze-jobs

pages:
  stage: deploy
  script:
    - mkdir -p public
    - mv .db-sqlite/joblist.db public/
  artifacts:
    paths:
      - public
  only:
    - schedules
